# ========================================================================
# ModSecurity DoS Protection Rules (Log with IP & Whitelist)
# ========================================================================

# ------------------------------------------------------------------------
# 1. [설정 구간] 관리자 설정
# ------------------------------------------------------------------------
SecAction \
    "id:900010,\
    phase:1,\
    pass,\
    nolog,\
    t:none,\
    setvar:'tx.dos_burst_time_slice=60',   \
    setvar:'tx.dos_counter_threshold=50', \
    setvar:'tx.dos_block_timeout=120'"


# ------------------------------------------------------------------------
# 1.5. [IP 예외 처리] 특정 IP는 DoS 검사 건너뛰기 (Whitelist)
# ------------------------------------------------------------------------
# 설명: 127.0.0.1 또는 192.168.0.0/24 대역은 검사를 수행하지 않고 END_DOS_PROTECTION 마커로 점프
# 필요한 IP를 쉼표(,)로 구분하여 추가하세요.
SecRule REMOTE_ADDR "@ipMatch 127.0.0.1,192.168.0.1" \
    "id:900015,\
    phase:1,\
    pass,\
    nolog,\
    t:none,\
    skipAfter:END_DOS_PROTECTION"


# ------------------------------------------------------------------------
# 2. [초기화] 저장소 생성
# ------------------------------------------------------------------------
SecRule REMOTE_ADDR "@rx .*" \
    "id:900020,\
    phase:1,\
    pass,\
    nolog,\
    t:none,\
    initcol:ip=%{REMOTE_ADDR},\
    setvar:ip.dos_counter=+0"


# ------------------------------------------------------------------------
# 3. [사전 차단] 이미 차단된 IP는 즉시 거부 (IP 기록 추가)
# ------------------------------------------------------------------------
SecRule IP:DOS_BAN "@eq 1" \
    "id:900030,\
    phase:1,\
    deny,\
    status:406,\
    msg:'DoS: Client is currently banned (IP: %{REMOTE_ADDR})',\
    logdata:'Blocked for %{tx.dos_block_timeout} seconds - Client IP: %{REMOTE_ADDR}'"


# ------------------------------------------------------------------------
# 4. [예외 처리] 정적 리소스 카운팅 건너뛰기
# ------------------------------------------------------------------------
SecRule REQUEST_BASENAME "@rx \.(?:jpg|jpeg|png|gif|css|js|ico|svg|woff|ttf|eot|mp4)$" \
    "id:900035,\
    phase:1,\
    pass,\
    t:none,\
    t:lowercase,\
    nolog,\
    skip:1"


# ------------------------------------------------------------------------
# 5. [카운팅] 접속 횟수 증가
# ------------------------------------------------------------------------
SecRule REMOTE_ADDR "@rx .*" \
    "id:900040,\
    phase:1,\
    pass,\
    nolog,\
    t:none,\
    setvar:ip.dos_counter=+1,\
    expirevar:ip.dos_counter=%{tx.dos_burst_time_slice}"


# ------------------------------------------------------------------------
# 6. [신규 차단] 임계치 초과 시 차단 및 Ban 설정 (IP 기록 추가)
# ------------------------------------------------------------------------
SecRule IP:DOS_COUNTER "@gt %{tx.dos_counter_threshold}" \
    "id:900050,\
    phase:1,\
    deny,\
    status:406,\
    msg:'DoS: Burst Limit Exceeded (IP: %{REMOTE_ADDR})',\
    logdata:'Request Count: %{ip.dos_counter} from IP: %{REMOTE_ADDR}',\
    setvar:ip.dos_ban=1,\
    expirevar:ip.dos_ban=%{tx.dos_block_timeout}"


# ------------------------------------------------------------------------
# [종료 마커] 예외 처리된 IP가 도착하는 곳
# ------------------------------------------------------------------------
SecMarker "END_DOS_PROTECTION"
