# ========================================================================
# ModSecurity DoS Protection Rules (Log with IP)
# ========================================================================

# ------------------------------------------------------------------------
# 1. [설정 구간] 관리자 설정
# ------------------------------------------------------------------------
SecAction \
    "id:900010,\
    phase:1,\
    pass,\
    nolog,\
    t:none,\
    setvar:'tx.dos_burst_time_slice=60',   \
    setvar:'tx.dos_counter_threshold=50', \
    setvar:'tx.dos_block_timeout=300'"


# ------------------------------------------------------------------------
# 2. [초기화] 저장소 생성
# ------------------------------------------------------------------------
SecRule REMOTE_ADDR "@rx .*" \
    "id:900020,\
    phase:1,\
    pass,\
    nolog,\
    t:none,\
    initcol:ip=%{REMOTE_ADDR},\
    setvar:ip.dos_counter=+0"


# ------------------------------------------------------------------------
# 3. [사전 차단] 이미 차단된 IP는 즉시 거부 (IP 기록 추가)
# ------------------------------------------------------------------------
# 수정됨: msg 부분에 (IP: %{REMOTE_ADDR}) 추가
SecRule IP:DOS_BAN "@eq 1" \
    "id:900030,\
    phase:1,\
    deny,\
    status:406,\
    msg:'DoS: Client is currently banned (IP: %{REMOTE_ADDR})',\
    logdata:'Block Expires in %{ip.dos_ban_timeout} seconds - Client IP: %{REMOTE_ADDR}'"


# ------------------------------------------------------------------------
# 4. [예외 처리] 정적 리소스 카운팅 건너뛰기
# ------------------------------------------------------------------------
SecRule REQUEST_BASENAME "@rx \.(?:jpg|jpeg|png|gif|css|js|ico|svg|woff|ttf|eot|mp4)$" \
    "id:900035,\
    phase:1,\
    pass,\
    t:none,\
    t:lowercase,\
    nolog,\
    skip:1"


# ------------------------------------------------------------------------
# 5. [카운팅] 접속 횟수 증가
# ------------------------------------------------------------------------
SecRule REMOTE_ADDR "@rx .*" \
    "id:900040,\
    phase:1,\
    pass,\
    nolog,\
    t:none,\
    setvar:ip.dos_counter=+1,\
    expirevar:ip.dos_counter=%{tx.dos_burst_time_slice}"


# ------------------------------------------------------------------------
# 6. [신규 차단] 임계치 초과 시 차단 및 Ban 설정 (IP 기록 추가)
# ------------------------------------------------------------------------
# 수정됨: msg와 logdata에 %{REMOTE_ADDR} 변수 추가
SecRule IP:DOS_COUNTER "@gt %{tx.dos_counter_threshold}" \
    "id:900050,\
    phase:1,\
    deny,\
    status:406,\
    msg:'DoS: Burst Limit Exceeded (IP: %{REMOTE_ADDR})',\
    logdata:'Request Count: %{ip.dos_counter} from IP: %{REMOTE_ADDR}',\
    setvar:ip.dos_ban=1,\
    expirevar:ip.dos_ban=%{tx.dos_block_timeout}"
