# ========================================================================
# ModSecurity DoS Protection Rules (Burst / 3-Strike Logic)
# ========================================================================

# ------------------------------------------------------------------------
# 1. [설정 구간] 관리자 설정
# ------------------------------------------------------------------------
# tx.dos_burst_time_slice: 카운터 초기화 주기 (60초)
# tx.dos_counter_threshold: 60초 내 허용 요청 수 (50회)
# tx.dos_block_timeout: 차단 시간 (300초 = 5분)
# tx.dos_burst_history_timeout: Strike 기억 시간 (600초 = 10분)
SecAction \
    "id:900010,\
    phase:1,\
    pass,\
    nolog,\
    t:none,\
    setvar:'tx.dos_burst_time_slice=60',   \
    setvar:'tx.dos_counter_threshold=50', \
    setvar:'tx.dos_block_timeout=300',    \
    setvar:'tx.dos_burst_history_timeout=600'"


# ------------------------------------------------------------------------
# 1.5. [IP 예외 처리] 특정 IP는 DoS 검사 건너뛰기 (Whitelist)
# ------------------------------------------------------------------------
SecRule REMOTE_ADDR "@ipMatch 127.0.0.1,192.168.0.1,::1" \
    "id:900015,\
    phase:1,\
    pass,\
    nolog,\
    t:none,\
    skipAfter:END_DOS_PROTECTION"


# ------------------------------------------------------------------------
# 2. [초기화] 저장소 생성
# ------------------------------------------------------------------------
SecRule REMOTE_ADDR "@rx .*" \
    "id:900020,\
    phase:1,\
    pass,\
    nolog,\
    t:none,\
    initcol:ip=%{REMOTE_ADDR},\
    setvar:ip.dos_counter=+0,\
    setvar:ip.dos_burst_strike=+0"


# ------------------------------------------------------------------------
# 3. [사전 차단] 이미 차단된 IP는 즉시 거부 (IP 기록 추가)
# ------------------------------------------------------------------------
SecRule IP:DOS_BAN "@eq 1" \
    "id:900030,\
    phase:1,\
    deny,\
    status:406,\
    msg:'DoS: Client is currently banned (IP: %{REMOTE_ADDR})',\
    logdata:'Blocked for %{tx.dos_block_timeout} seconds - Client IP: %{REMOTE_ADDR}'"


# ------------------------------------------------------------------------
# 4. [예외 처리] 정적 리소스는 DoS 로직 전체 건너뛰기 (최신 확장자 포함)
# ------------------------------------------------------------------------
# 설명: 이미지, 폰트, 미디어, 소스맵 등은 요청 카운트에서 제외하고 로직을 종료합니다.
# 주의: API 서버라서 .json으로 로직 처리를 하는 경우 아래 목록에서 'json'은 빼야 합니다.
SecRule REQUEST_BASENAME "@rx \.(?:bmp|jpg|jpeg|png|gif|webp|avif|heic|tif|tiff|css|js|map|ico|svg|woff|woff2|ttf|eot|otf|mp4|webm|ogg|avi|mov|mp3|wav|m4a|pdf|txt|xml|json)$" \
    "id:900035,\
    phase:1,\
    pass,\
    t:none,\
    t:lowercase,\
    nolog,\
    skipAfter:END_DOS_PROTECTION"


# ------------------------------------------------------------------------
# 5. [카운팅] 접속 횟수 증가
# ------------------------------------------------------------------------
SecRule REMOTE_ADDR "@rx .*" \
    "id:900040,\
    phase:1,\
    pass,\
    nolog,\
    t:none,\
    setvar:ip.dos_counter=+1,\
    expirevar:ip.dos_counter=%{tx.dos_burst_time_slice}"


# ------------------------------------------------------------------------
# 6. [Burst 감지] 임계치 초과 시 스트라이크 증가 (차단 아님, 카운터 리셋)
# ------------------------------------------------------------------------
# 설명: 60초 내 50회 초과 시 Strike +1, 카운터 0 초기화
SecRule IP:DOS_COUNTER "@gt %{tx.dos_counter_threshold}" \
    "id:900050,\
    phase:1,\
    pass,\
    t:none,\
    log,\
    msg:'DoS: Burst Threshold Reached - Strike (IP: %{REMOTE_ADDR})',\
    setvar:ip.dos_burst_strike=+1,\
    setvar:ip.dos_counter=0,\
    expirevar:ip.dos_burst_strike=%{tx.dos_burst_history_timeout}"


# ------------------------------------------------------------------------
# 7. [최종 차단] 스트라이크 3회 누적 시 차단 및 Ban 설정
# ------------------------------------------------------------------------
# 수정됨: @ge 3 (Strike 3회 시 차단)
# 추가됨: setvar:ip.dos_burst_strike=0 (차단 시 Strike 초기화 -> 해제 후 재기회 부여)
SecRule IP:DOS_BURST_STRIKE "@ge 3" \
    "id:900060,\
    phase:1,\
    deny,\
    status:406,\
    msg:'DoS: Sustained Attack Detected - Blocking (IP: %{REMOTE_ADDR})',\
    logdata:'Strike Count: %{ip.dos_burst_strike} - Banning IP',\
    setvar:ip.dos_ban=1,\
    expirevar:ip.dos_ban=%{tx.dos_block_timeout},\
    setvar:ip.dos_burst_strike=0"


# ------------------------------------------------------------------------
# [종료 마커]
# ------------------------------------------------------------------------
SecMarker "END_DOS_PROTECTION"
