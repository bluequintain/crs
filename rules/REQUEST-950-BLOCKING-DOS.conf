# Initialize and increment counter for every request
SecRule REQUEST_METHOD ".*" "id:99100100,phase:2,initcol:ip=%{REMOTE_ADDR},setvar:ip.count=+1,expirevar:ip.count=60,pass,nolog"

# Block if requests exceed 50 in 60 seconds
SecRule IP:COUNT "@gt 50" "id:99100101,phase:2,block,nolog,msg:'%{REMOTE_ADDR} blocked due to excessive requests in 60 seconds',setvar:ip.blocked=1,expirevar:ip.blocked=300"

# Block if IP is marked as blocked
SecRule IP:BLOCKED "@eq 1" "id:99100102,phase:2,deny,status:406,log,msg:'%{REMOTE_ADDR} is currently blocked due to earlier DoS detection'"
